<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Passport Photo Maker</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        lato: ['Lato', 'sans-serif'],
                        montserrat: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        primary: '#10B981', // Emerald 500
                        secondary: '#34D399', // Emerald 400
                        accent: '#6EE7B7', // Emerald 300
                        light: '#D1FAE5', // Emerald 100
                        dark: '#1F2937', // Gray 800 - Used for general dark text
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Montserrat:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
            color: #374151; /* Dark gray text */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0 20v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zM6 46v-4H4v4H0v2h4v4h2v-4h4v-2H6zm0-20v-4H4v4H0v2h4v4h2v-4h4v-2H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            background-size: 60px 60px;
        }
        .container {
            max-width: 1024px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        h1, h2 {
            font-family: 'Montserrat', sans-serif;
            color: #1F2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            text-align: center;
            color: #10B981; /* Primary color for main title */
        }
        h2 {
            font-size: 1.75rem;
            font-weight: 600;
            border-bottom: 2px solid #D1FAE5; /* Light emerald border */
            padding-bottom: 0.75rem;
            margin-top: 2rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            margin-top: 0.25rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            border-color: #34D399; /* Secondary color on focus */
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 211, 153, 0.2);
        }
        .form-section-group {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background-color: #F9FAFB;
            border-radius: 0.75rem;
            border: 1px solid #E5E7EB;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-section-group:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 18px -3px rgba(0, 0, 0, 0.15), 0 6px 9px -2px rgba(0, 0, 0, 0.08);
        }
        .btn-primary, .btn-secondary {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        .btn-primary {
            background-color: #10B981;
            color: #ffffff;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.1), 0 2px 4px -1px rgba(16, 185, 129, 0.06);
        }
        .btn-primary:hover {
            background-color: #34D399;
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(16, 185, 129, 0.15), 0 3px 6px -1px rgba(16, 185, 129, 0.08);
        }
        .btn-secondary {
            background-color: #D1FAE5;
            color: #10B981;
            border: 1px solid #10B981;
        }
        .btn-secondary:hover {
            background-color: #A7F3D0;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.05), 0 2px 4px -1px rgba(16, 185, 129, 0.03);
        }
        .form-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* Image Upload Area */
        .image-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        .image-preview-box {
            width: 250px;
            height: 250px;
            border: 2px dashed #9CA3AF;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            background-color: #F3F4F6;
            position: relative;
            transition: border-color 0.2s, transform 0.2s;
        }
        .image-preview-box:hover {
            border-color: #10B981;
            transform: scale(1.02);
        }
        .image-preview-box img {
            width: 100%;
            height: 100%;
            object-fit: contain; /* Use contain for initial preview */
        }
        #image-placeholder {
            color: #6B7280;
            text-align: center;
        }
        #image-placeholder .fas {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        /* Modal Styling */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #ffffff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E5E7EB;
            padding-bottom: 1rem;
        }
        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: #1F2937;
        }
        .modal-body {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }
        .modal-body img {
            max-width: 100%;
            max-height: 500px;
            display: block;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            border-top: 1px solid #E5E7EB;
            padding-top: 1rem;
        }

        /* Message Box Styling */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: #10B981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1100;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        }
        .message-box.show {
            opacity: 1;
            transform: translateY(0);
        }
        .message-box.error {
            background-color: #EF4444;
        }
        .message-box.success {
            background-color: #22C55E;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #ffffff;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: none;
        }
        .btn-primary .spinner {
            border-top-color: #10B981;
        }
        .btn-primary.loading .spinner {
            display: inline-block;
        }
        .btn-primary.loading {
            cursor: not-allowed;
            opacity: 0.8;
        }
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Confetti Container */
        #confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1050;
            overflow: hidden;
        }
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background-color: var(--confetti-color);
            opacity: 0;
            animation: confetti-fall 3s forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 0;
                transform: translateY(-100px) rotateZ(0deg);
            }
            10% {
                opacity: 1;
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotateZ(720deg);
            }
        }

        /* Output Canvas Preview */
        #output-canvas-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            border: 1px solid #D1D5DB;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem;
            overflow: hidden;
            background-color: #ffffff;
        }
        #output-canvas {
            display: block;
            background-color: #ffffff;
            max-width: 100%; /* Ensure canvas scales down on small screens */
            height: auto; /* Maintain aspect ratio */
        }

        /* Footer */
        .credits {
            text-align: center;
            margin-top: 3rem;
            padding: 1rem;
            color: #6B7280;
            font-size: 0.875rem;
        }
        .credits a {
            color: #10B981;
            text-decoration: none;
            font-weight: 600;
        }
        .credits a:hover {
            text-decoration: underline;
        }
        .step-indicator {
            background-color: #E0E7FF; /* Light indigo */
            color: #4F46E5; /* Primary indigo */
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Full rounded */
            font-size: 0.875rem;
            font-weight: 600;
            margin-right: 0.5rem;
        }
        .step-section h2 {
            border-bottom: none; /* Remove default border for step headers */
            margin-bottom: 1rem;
        }
        .step-section {
            background-color: #F9FAFB;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #E5E7EB;
        }
        .step-section h2 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #1F2937;
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #output-canvas-container, #output-canvas-container * {
                visibility: visible;
            }
            #output-canvas-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 0;
                display: block !important; /* Ensure it's not flex during print */
            }
            #output-canvas {
                width: 100%;
                height: auto;
                max-width: none;
            }
            .form-actions, .credits, .message-box, .modal, #confetti-container, .step-section:not(#output-section) {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-id-card"></i> Passport Photo Maker by <a href="https://www.instagram.com/nishix_vamp/" target="_blank" rel="noopener noreferrer" class="text-primary hover:underline">Nishikant Xalxo</a></h1>
        <p class="text-center text-sm text-gray-500 mb-4">Create and print perfect passport-size photos.</p>

        <div id="app-sections" class="space-y-8">

            <div id="step-1" class="step-section">
                <h2><span class="step-indicator">1</span> Upload & Crop Your Photo</h2>
                <div class="image-upload-area">
                    <input type="file" id="photo-upload-input" accept="image/*" class="hidden">
                    <div class="image-preview-box" id="image-preview-box">
                        <img id="image-to-crop-preview" src="" alt="Uploaded Photo Preview" class="hidden">
                        <p id="image-placeholder"><i class="fas fa-camera"></i> Click to upload photo</p>
                    </div>
                    <button type="button" id="crop-photo-btn" class="btn-primary hidden">
                        <i class="fas fa-crop-alt"></i> Crop Photo
                    </button>
                </div>
            </div>

            <div id="step-2" class="step-section">
                <h2><span class="step-indicator">2</span> Configure Photo & Page Layout</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="photo-unit">Photo Size Unit:</label>
                        <select id="photo-unit" class="mt-1">
                            <option value="px">Pixels (px)</option>
                            <option value="mm" selected>Millimeters (mm)</option>
                            <option value="inch">Inches (inch)</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="photo-width">Photo Width:</label>
                            <input type="number" id="photo-width" value="35" min="1" class="mt-1" required>
                        </div>
                        <div>
                            <label for="photo-height">Photo Height:</label>
                            <input type="number" id="photo-height" value="45" min="1" class="mt-1" required>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label for="horizontal-spacing">Horizontal Spacing:</label>
                        <input type="number" id="horizontal-spacing" value="0" min="0" class="mt-1" required>
                    </div>
                    <div>
                        <label for="vertical-spacing">Vertical Spacing:</label>
                        <input type="number" id="vertical-spacing" value="0" min="0" class="mt-1" required>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="page-size">Page Size:</label>
                        <select id="page-size" class="mt-1">
                            <option value="A4">A4 (210 x 297 mm)</option>
                            <option value="Letter">Letter (216 x 279 mm)</option>
                            <option value="4R">4R (102 x 152 mm)</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                    <div class="grid grid-cols-2 gap-4" id="custom-page-size-inputs" style="display: none;">
                        <div>
                            <label for="page-width">Custom Page Width (mm):</label>
                            <input type="number" id="page-width" value="210" min="1" class="mt-1">
                        </div>
                        <div>
                            <label for="page-height">Custom Page Height (mm):</label>
                            <input type="number" id="page-height" value="297" min="1" class="mt-1">
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <label for="num-photos">Number of Photos on Page:</label>
                    <input type="number" id="num-photos" value="8" min="1" class="mt-1" required>
                </div>

                <div class="flex justify-center mt-8">
                    <button type="button" id="generate-layout-btn" class="btn-primary">
                        <span class="spinner"></span>
                        <i class="fas fa-th-large"></i> Generate Layout
                    </button>
                </div>
            </div>

            <div id="step-3" class="step-section hidden">
                <h2><span class="step-indicator">3</span> Preview & Export</h2>
                <div id="output-canvas-container" class="w-full h-auto">
                    <canvas id="output-canvas" class="block"></canvas>
                </div>
                <div class="form-actions mt-8">
                    <button type="button" id="download-pdf-btn" class="btn-primary">
                        <span class="spinner"></span>
                        <i class="fas fa-file-pdf"></i> Download PDF
                    </button>
                    <button type="button" id="print-btn" class="btn-secondary">
                        <i class="fas fa-print"></i> Print Photos
                    </button>
                    <button type="button" id="share-app-btn" class="btn-secondary">
                        <i class="fas fa-share-alt"></i> Share App
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="crop-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Crop Your Photo</h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="modal-body">
                <img id="image-to-crop" src="" alt="Image to crop">
            </div>
            <div class="modal-footer">
                <button id="confirm-crop-btn" class="btn-primary"><i class="fas fa-check"></i> Confirm Crop</button>
            </div>
        </div>
    </div>

    <div id="message-box" class="message-box hidden"></div>
    <div id="confetti-container"></div>

    <footer class="credits">
        Built with passion by <a href="https://www.instagram.com/nishix_vamp/" target="_blank" rel="noopener noreferrer">nishix_vamp</a>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        // DOM Elements
        const photoUploadInput = document.getElementById('photo-upload-input');
        const imagePreviewBox = document.getElementById('image-preview-box');
        const imagePlaceholder = document.getElementById('image-placeholder');
        const imageToCropPreview = document.getElementById('image-to-crop-preview');
        const cropPhotoBtn = document.getElementById('crop-photo-btn');

        const cropModal = document.getElementById('crop-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const imageToCrop = document.getElementById('image-to-crop');
        const confirmCropBtn = document.getElementById('confirm-crop-btn');

        const photoUnitSelect = document.getElementById('photo-unit');
        const photoWidthInput = document.getElementById('photo-width');
        const photoHeightInput = document.getElementById('photo-height');
        const horizontalSpacingInput = document.getElementById('horizontal-spacing'); // New
        const verticalSpacingInput = document.getElementById('vertical-spacing');   // New
        const pageSizeSelect = document.getElementById('page-size');
        const customPageSizeInputs = document.getElementById('custom-page-size-inputs');
        const pageWidtInput = document.getElementById('page-width');
        const pageHeightInput = document.getElementById('page-height');
        const numPhotosInput = document.getElementById('num-photos');
        const generateLayoutBtn = document.getElementById('generate-layout-btn');

        const step1Section = document.getElementById('step-1');
        const step2Section = document.getElementById('step-2');
        const step3Section = document.getElementById('step-3');

        const outputCanvasContainer = document.getElementById('output-canvas-container');
        const outputCanvas = document.getElementById('output-canvas');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const printBtn = document.getElementById('print-btn');
        const shareAppBtn = document.getElementById('share-app-btn');

        const messageBox = document.getElementById('message-box');
        const confettiContainer = document.getElementById('confetti-container');

        let cropper; // Cropper.js instance
        let croppedImageBase64 = null; // Stores the cropped image data URL
        const DPI = 300; // Dots per inch for print quality

        // --- Utility Functions ---

        /**
         * Displays a temporary message box.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of message (for styling).
         */
        function showMessage(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `message-box show ${type}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.remove('show');
                messageBox.classList.add('hidden');
            }, 3000);
        }

        /**
         * Toggles the loading state of a button.
         * @param {HTMLButtonElement} button - The button element.
         * @param {boolean} isLoading - True to show loading, false to hide.
         */
        function toggleLoading(button, isLoading) {
            const spinnerElement = button.querySelector('.spinner');
            if (isLoading) {
                button.classList.add('loading');
                button.disabled = true;
                if (spinnerElement) {
                    spinnerElement.style.display = 'inline-block';
                }
            } else {
                button.classList.remove('loading');
                button.disabled = false;
                if (spinnerElement) {
                    spinnerElement.style.display = 'none';
                }
            }
        }

        /**
         * Triggers a confetti animation.
         */
        function launchConfetti() {
            const colors = ['#f44336', '#e91e63', '#9c27b0', '#673ab7', '#3f51b5', '#2196f3', '#03a9f4', '#00bcd4', '#009688', '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107', '#FF9800', '#FF5722', '#795548', '#9E9E9E', '#607D8B'];
            const numConfetti = 50;

            for (let i = 0; i < numConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.classList.add('confetti');
                confetti.style.setProperty('--confetti-color', colors[Math.floor(Math.random() * colors.length)]);
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDelay = `${Math.random() * 0.5}s`;
                confettiContainer.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }

        /**
         * Converts a value from one unit to pixels based on DPI.
         * @param {number} value - The value to convert.
         * @param {string} unit - The original unit ('mm', 'inch', 'px').
         * @param {number} dpi - Dots per inch.
         * @returns {number} Value in pixels.
         */
        function convertToPixels(value, unit, dpi) {
            switch (unit) {
                case 'mm':
                    return (value / 25.4) * dpi; // 1 inch = 25.4 mm
                case 'inch':
                    return value * dpi;
                case 'px':
                default:
                    return value;
            }
        }

        /**
         * Converts a value from pixels to a target unit based on DPI.
         * @param {number} valuePx - The value in pixels.
         * @param {string} targetUnit - The target unit ('mm', 'inch', 'px').
         * @param {number} dpi - Dots per inch.
         * @returns {number} Value in target unit.
         */
        function convertFromPixels(valuePx, targetUnit, dpi) {
            switch (targetUnit) {
                case 'mm':
                    return (valuePx / dpi) * 25.4;
                case 'inch':
                    return valuePx / dpi;
                case 'px':
                default:
                    return valuePx;
            }
        }

        // --- Step 1: Upload and Crop Photo ---

        imagePreviewBox.addEventListener('click', () => photoUploadInput.click());

        photoUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageToCrop.src = e.target.result;
                    cropModal.classList.remove('hidden');
                    if (cropper) {
                        cropper.destroy();
                    }
                    imageToCrop.onload = () => {
                        cropper = new Cropper(imageToCrop, {
                            aspectRatio: NaN, // Allow free aspect ratio initially for user to define
                            viewMode: 1,
                            movable: true,
                            zoomable: true,
                            rotatable: false,
                            scalable: false,
                            background: false,
                            autoCropArea: 0.8
                        });
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        closeModalBtn.addEventListener('click', () => {
            cropModal.classList.add('hidden');
            if (cropper) {
                cropper.destroy();
            }
            photoUploadInput.value = ''; // Clear file input
        });

        confirmCropBtn.addEventListener('click', () => {
            if (cropper) {
                croppedImageBase64 = cropper.getCroppedCanvas({
                    width: cropper.getData().width, // Use actual cropped dimensions
                    height: cropper.getData().height,
                    fillColor: '#fff'
                }).toDataURL('image/png');

                imageToCropPreview.src = croppedImageBase64;
                imageToCropPreview.classList.remove('hidden');
                imagePlaceholder.classList.add('hidden');
                cropPhotoBtn.classList.remove('hidden'); // Show crop button to re-crop if needed

                cropModal.classList.add('hidden');
                cropper.destroy();
                showMessage('Photo cropped successfully!', 'success');
            } else {
                showMessage('No image to crop.', 'error');
            }
        });

        cropPhotoBtn.addEventListener('click', () => {
            if (croppedImageBase64) {
                imageToCrop.src = croppedImageBase64; // Load the previously cropped image for re-cropping
                cropModal.classList.remove('hidden');
                if (cropper) {
                    cropper.destroy();
                }
                imageToCrop.onload = () => {
                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: NaN,
                        viewMode: 1,
                        movable: true,
                        zoomable: true,
                        rotatable: false,
                        scalable: false,
                        background: false,
                        autoCropArea: 0.8
                    });
                };
            } else {
                showMessage('Please upload a photo first.', 'info');
            }
        });


        // --- Step 2: Configure Photo & Page Size ---

        photoUnitSelect.addEventListener('change', () => {
            const currentUnit = photoUnitSelect.value;
            // Standard passport photo sizes (e.g., 35x45mm, 2x2inch)
            if (currentUnit === 'mm') {
                photoWidthInput.value = 35;
                photoHeightInput.value = 45;
            } else if (currentUnit === 'inch') {
                photoWidthInput.value = 2;
                photoHeightInput.value = 2;
            } else { // px
                photoWidthInput.value = convertToPixels(35, 'mm', DPI).toFixed(0);
                photoHeightInput.value = convertToPixels(45, 'mm', DPI).toFixed(0);
            }
            // Reset spacing values to 0 when unit changes, as they are unit-dependent
            horizontalSpacingInput.value = 0;
            verticalSpacingInput.value = 0;
        });

        pageSizeSelect.addEventListener('change', () => {
            if (pageSizeSelect.value === 'Custom') {
                customPageSizeInputs.style.display = 'grid';
            } else {
                customPageSizeInputs.style.display = 'none';
                // Set standard values for A4 or Letter
                if (pageSizeSelect.value === 'A4') {
                    pageWidtInput.value = 210;
                    pageHeightInput.value = 297;
                } else if (pageSizeSelect.value === 'Letter') {
                    pageWidtInput.value = 216;
                    pageHeightInput.value = 279;
                } else if (pageSizeSelect.value === '4R') { // New 4R size
                    pageWidtInput.value = 102;
                    pageHeightInput.value = 152;
                }
            }
        });

        generateLayoutBtn.addEventListener('click', async () => {
            if (!croppedImageBase64) {
                showMessage('Please upload and crop a photo first!', 'error');
                return;
            }

            toggleLoading(generateLayoutBtn, true);
            showMessage('Generating photo layout...', 'info');

            const photoUnit = photoUnitSelect.value;
            const photoWidth = parseFloat(photoWidthInput.value);
            const photoHeight = parseFloat(photoHeightInput.value);
            const horizontalSpacing = parseFloat(horizontalSpacingInput.value); // New
            const verticalSpacing = parseFloat(verticalSpacingInput.value);     // New
            const numPhotos = parseInt(numPhotosInput.value, 10);

            let pageWidthMm, pageHeightMm;
            if (pageSizeSelect.value === 'Custom') {
                pageWidthMm = parseFloat(pageWidtInput.value);
                pageHeightMm = parseFloat(pageHeightInput.value);
            } else if (pageSizeSelect.value === 'A4') {
                pageWidthMm = 210;
                pageHeightMm = 297;
            } else if (pageSizeSelect.value === 'Letter') {
                pageWidthMm = 216;
                pageHeightMm = 279;
            } else if (pageSizeSelect.value === '4R') { // New 4R size
                pageWidthMm = 102;
                pageHeightMm = 152;
            }

            if (isNaN(photoWidth) || isNaN(photoHeight) || isNaN(horizontalSpacing) || isNaN(verticalSpacing) || isNaN(numPhotos) || isNaN(pageWidthMm) || isNaN(pageHeightMm) || photoWidth <= 0 || photoHeight <= 0 || numPhotos <= 0 || pageWidthMm <= 0 || pageHeightMm <= 0) {
                showMessage('Please enter valid dimensions, spacing, and number of photos.', 'error');
                toggleLoading(generateLayoutBtn, false);
                return;
            }

            // Convert photo and spacing dimensions to pixels for drawing on canvas
            const photoWidthPx = convertToPixels(photoWidth, photoUnit, DPI);
            const photoHeightPx = convertToPixels(photoHeight, photoUnit, DPI);
            const horizontalSpacingPx = convertToPixels(horizontalSpacing, photoUnit, DPI); // New
            const verticalSpacingPx = convertToPixels(verticalSpacing, photoUnit, DPI);     // New

            // Convert page dimensions to pixels for canvas size
            const pageWidthPx = convertToPixels(pageWidthMm, 'mm', DPI);
            const pageHeightPx = convertToPixels(pageHeightMm, 'mm', DPI);

            outputCanvas.width = pageWidthPx;
            outputCanvas.height = pageHeightPx;
            const ctx = outputCanvas.getContext('2d');
            ctx.clearRect(0, 0, outputCanvas.width, outputCanvas.height);
            ctx.fillStyle = '#ffffff'; // Set background to white
            ctx.fillRect(0, 0, outputCanvas.width, outputCanvas.height);

            const img = new Image();
            img.src = croppedImageBase64;

            img.onload = () => {
                let currentPhotoCount = 0;
                let currentRow = 0;
                let currentCol = 0;

                // Calculate available space for photos including spacing
                const effectivePhotoWidth = photoWidthPx + horizontalSpacingPx;
                const effectivePhotoHeight = photoHeightPx + verticalSpacingPx;

                // Calculate how many photos can fit horizontally and vertically considering spacing
                const maxPhotosPerRow = Math.floor(pageWidthPx / effectivePhotoWidth);
                const maxPhotosPerCol = Math.floor(pageHeightPx / effectivePhotoHeight);

                if (maxPhotosPerRow === 0 || maxPhotosPerCol === 0) {
                    showMessage('Photo size plus spacing is too large for the selected page size.', 'error');
                    toggleLoading(generateLayoutBtn, false);
                    return;
                }

                // Calculate total width/height used by photos and spacing
                const totalPhotosWidth = maxPhotosPerRow * photoWidthPx + (maxPhotosPerRow - 1) * horizontalSpacingPx;
                const totalPhotosHeight = maxPhotosPerCol * photoHeightPx + (maxPhotosPerCol - 1) * verticalSpacingPx;

                // Calculate remaining space for centering
                const remainingWidth = pageWidthPx - totalPhotosWidth;
                const remainingHeight = pageHeightPx - totalPhotosHeight;

                // Calculate starting offset for centering
                const startX = remainingWidth / 2;
                const startY = remainingHeight / 2;


                while (currentPhotoCount < numPhotos && currentRow < maxPhotosPerCol) {
                    const x = startX + (currentCol * effectivePhotoWidth);
                    const y = startY + (currentRow * effectivePhotoHeight);

                    // Check if photo fits within the page boundaries
                    if (x + photoWidthPx <= pageWidthPx && y + photoHeightPx <= pageHeightPx) {
                        ctx.drawImage(img, x, y, photoWidthPx, photoHeightPx);
                        currentPhotoCount++;
                    }

                    currentCol++;
                    if (currentCol >= maxPhotosPerRow) {
                        currentCol = 0;
                        currentRow++;
                    }
                }

                if (currentPhotoCount < numPhotos) {
                    showMessage(`Warning: Only ${currentPhotoCount} photos could fit on the page out of ${numPhotos} requested.`, 'info');
                } else {
                    showMessage('Photo layout generated successfully!', 'success');
                }

                step3Section.classList.remove('hidden'); // Show preview section
                toggleLoading(generateLayoutBtn, false);
                launchConfetti();
            };

            img.onerror = () => {
                showMessage('Failed to load cropped image. Please re-upload.', 'error');
                toggleLoading(generateLayoutBtn, false);
            };
        });

        // --- Step 3: Preview & Download/Print ---

        downloadPdfBtn.addEventListener('click', async () => {
            toggleLoading(downloadPdfBtn, true);
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', [pageWidtInput.value, pageHeightInput.value]); // Use dynamic page size

            html2canvas(outputCanvas, {
                scale: 2, // Higher scale for better PDF quality
                useCORS: true,
                logging: false,
                allowTaint: true,
                removeContainer: true,
                backgroundColor: '#ffffff' // Ensure white background
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                const aspectRatio = imgProps.width / imgProps.height;

                let imgWidth = pdfWidth;
                let imgHeight = pdfWidth / aspectRatio;

                if (imgHeight > pdfHeight) {
                    imgHeight = pdfHeight;
                    imgWidth = pdfHeight * aspectRatio;
                }

                const xOffset = (pdfWidth - imgWidth) / 2;
                const yOffset = (pdfHeight - imgHeight) / 2;

                pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
                pdf.save('passport-photos.pdf');
                toggleLoading(downloadPdfBtn, false);
                showMessage('PDF downloaded successfully!', 'success');
            }).catch(error => {
                console.error("Error generating PDF:", error);
                showMessage('Failed to download PDF. Please try again.', 'error');
                toggleLoading(downloadPdfBtn, false);
            });
        });

        printBtn.addEventListener('click', () => {
            if (!outputCanvas.getContext('2d').getImageData(0, 0, outputCanvas.width, outputCanvas.height).data.some(channel => channel !== 0)) {
                showMessage('No photos generated to print. Please generate layout first.', 'info');
                return;
            }
            window.print();
        });

        shareAppBtn.addEventListener('click', () => {
            const appUrl = window.location.href;
            const tempInput = document.createElement('textarea');
            tempInput.value = appUrl;
            document.body.appendChild(tempInput);
            tempInput.select();
            try {
                document.execCommand('copy');
                showMessage('App link copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy text: ', err);
                showMessage('Failed to copy link. Please copy manually: ' + appUrl, 'error');
            } finally {
                document.body.removeChild(tempInput);
            }
        });

        // Initialize custom page size inputs visibility and default photo unit
        document.addEventListener('DOMContentLoaded', () => {
            if (pageSizeSelect.value === 'Custom') {
                customPageSizeInputs.style.display = 'grid';
            } else {
                customPageSizeInputs.style.display = 'none';
            }
            // Set initial photo size values based on the default 'mm' unit
            photoWidthInput.value = 35;
            photoHeightInput.value = 45;
        });
    </script>
</body>
</html>
